# Charlie Reporting - Copilot Context (Ultra-Condensed)

Updated: 2025-08-15

## Mission

Ingest CSV drops → SQLite → hourly & quad-daily aggregations → Excel workbooks (future: email + SharePoint). Keep it small, fast, observable.

## Active Modules

| Name | Role | Key Notes |
|------|------|-----------|
| collector | Find new CSVs (pattern/time) | Plan: mark/move to staging, avoid reprocessing |
| loader | Parse & insert rows | Add ingestion_log (file_hash, loaded_at) |
| aggregator | Hour/quad-daily rollups | Pure SQL/pandas; no heavy ORM |
| excel_builder | Workbook + minimal formatting | Output to reports/; HTML (future) |
| api | /health /ingest /generate/hourly | /generate/daily upcoming |
| sharepoint_stub | Placeholder for remote fetch | Will evolve to real Graph sync |

## Core Flow

```text
incoming_csvs -> collector -> staging -> loader -> sqlite -> aggregator -> excel_builder -> reports/*.xlsx
```

## Config

Single file: `config/settings.toml` (schedules, sources, columns, output). Fail fast if missing sections.

## Quality & Testing

See `docs/testing-approach.md`.

- 70% unit / 25% integration / 5% smoke.
- Assert outputs (rows, columns, sheet names, HTTP status), not internals.

## Current Tactical Backlog

- [ ] ingestion_log table (dedupe & idempotency)
- [ ] run_history (timings, row counts, status)
- [ ] /generate/daily endpoint
- [ ] Basic logging helper (structured line)
- [ ] Cron or APScheduler harness
- [ ] SharePoint pull prototype
- [ ] Email packaging stub

## Principles

1. Minimal surface; grow only when pain emerges.
2. Persist early; transform late.
3. Clear failures (log + skip) over silent drops.
4. Prefer deletion to abstraction.
5. Pipeline always runnable after each commit.
6. Tests-first (write failing pytest before impl) and green ruff+mypy on touched code before commit.
7. Write a lightweight design spec (behavior contract) before writing the first failing test for any non-trivial change (new table, endpoint, scheduler, aggregation logic).

## Dev Workflow (Essentials)

1. Create small branch (feature/ingestion-log).
2. Draft Design Spec (inputs, outputs, data shape, error modes, success criteria) in `docs/design-specs/` or inline in test module docstring.
3. Add/adjust failing test (TDD red phase) encoding the spec.
4. Implement minimal code → green tests.
5. Run quick gates: ruff, mypy, pytest on touched code.
6. Refactor (maintain green) & update spec if behavior refined.
7. Update docs if config/endpoints change.
8. Merge; post concise status if user-visible change.

## Quality Gates (Always Pass Before Commit)

| Gate | Command | Rule |
|------|---------|------|
| Lint | ruff check . | No new violations in changed files |
| Types | mypy . | No new errors in changed files |
| Tests | pytest -q | All pass; new tests added for new behavior |
| Design Spec | review spec doc/pr description | Present for non-trivial features |
| Docs | n/a | Context & README updated if contracts change |

## Key Commands (conceptual)

| Goal | Command |
|------|---------|
| Run API | `python -m foundation.src.services.api` |
| Ingest (API) | `POST /ingest` |
| Hourly report | `POST /generate/hourly` |
| Tests | `pytest -q` |
| Lint | `ruff check .` |

## Logging (Planned Format)

`ts=<iso> stage=<collector|loader|agg|excel|api> file=<name> rows=<n> ms=<dur>`

## Minimal Coding Conventions

- snake_case variables; PascalCase classes.
- Absolute imports within project.
- Type hints on public functions.
- Keep functions short & pure where possible.

## Removed / Deferred

| Item | Reason |
|------|--------|
| Multi-service architecture | Overhead > value now |
| Kubernetes / Docker stack | Single-process sufficient |
| Prometheus metrics | Start with simple counters in DB |
| Full email automation | Add after stable pipeline |

## Decision Log (Recent)

- 2025-08-15 Reset to monolith; pruned microservice docs/code.

## When Stuck

1. Reproduce with smallest CSV.
2. Add failing test.
3. Fix minimally.
4. Log root cause in PR description.

## Exit Criteria for Backlog Items

| Item | Done When |
|------|-----------|
| ingestion_log | Duplicate file ignored; test proves idempotency |
| run_history | Each run row persisted with counts & duration |
| /generate/daily | Endpoint returns workbook with expected sheets |

---

Keep this file under ~200 lines. Trim anything not actively influencing next engineering steps.
